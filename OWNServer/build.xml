<project name="OWNServer" default="create.dist" basedir=".">

	<!-- Main Jar -->
	<property name="app.name" value="OWNServer" />
	<property name="version" value="0.5.2" />
	<property name="jar.main.name" value="${app.name}-${version}" />
	<property name="main.class" value="org.programmatori.domotica.own.server.Controller" />
	
	<!-- SDK Jar -->
	<property name="sdk.dist" value="../OWN-SDK_Git" />
	
	<!-- Emulator Jar -->
	<property name="emu.dist" value="../OWNEngine-Emulator_Git" />

	<!-- general -->
	<property name="project.home" value="${basedir}" />
	<property name="workspace" value="${project.home}/.." />
	<property name="dest" value="dest" />
	<property name="dir.dist" value="${project.home}/${dest}" />
	

	<property name="build" value="${project.home}/bin" />
	<property name="lib.dir" value="/lib" />
	<property name="conf.dir" value="/conf" />
	<property name="log.dir" value="/log" />

	<path id="classpath">
		<fileset dir="${dir.dist}${lib.dir}" includes="*.jar" />
	</path>

	<tstamp>
		<format property="TODAY" pattern="dd/MM/yyyy" />
	</tstamp>

<target name="clean" description="Destroys all generated files and dirs.">
	<delete dir="${dir.dist}" />
</target>

<target name="prepare.dist"> <!-- depends="clean">-->
	<mkdir dir="${dir.dist}/${lib.dir}" />
	<mkdir dir="${dir.dist}/${conf.dir}" />
	<mkdir dir="${dir.dist}/${log.dir}" />
	
	<!-- copy the libs that you need to "lib" directory  -->
	<copy todir="${dir.dist}${lib.dir}">
		<fileset dir="${project.home}${lib.dir}" includes="*.jar" />
	</copy>
</target>
	
<target name="shell" depends="prepare.dist">
	<echo message="Create Windows batch" />
	<echo file="${dir.dist}/${app.name}.bat">@echo off
java -jar ${jar.main.name}.jar
	</echo>
	
	<echo message="Create Linux batch" />
	<echo file="${dir.dist}/${app.name}.sh">#!/bin/sh
java -jar ${jar.main.name}.jar
	</echo>
</target>

<target name="jar.sdk" depends="prepare.dist">
	<manifestclasspath property="jar.sdk.classpath" jarfile="${dir.dist}/${lib.dir}/${jar.sdk.name}.jar">
		<classpath refid="classpath" />
	</manifestclasspath>

	<echo message="lib: ${jar.sdk.classpath}" level="debug" />

	<!-- creates your jar with the contents inside "bin" (now with your .class and .jar dependencies) -->
	<jar destfile="${dir.dist}/${lib.dir}/${jar.sdk.name}.jar">
		<fileset dir="${build}">
			<include name="**/*.class" />
			<include name="**/*.properties" />
			<exclude name="**/test/*.class" />
			<exclude name="**/bus/*.class" />
			<exclude name="**/emulator/*.class" />
			<exclude name="**/server/*.class" />
			<exclude name="**/plugin/*.class" />
		</fileset>
		<manifest>
			<!-- Who is building this jar? -->
			<attribute name="Built-By" value="${user.name}" />
			<!-- Information about the program itself -->
			<attribute name="Implementation-Title" value="${sdk.name}" />
			<attribute name="Implementation-Version" value="${sdk.version}" />
			<attribute name="Class-Path" value="${jar.sdk.classpath}" />
			<attribute name="Built-Date" value="${TODAY}" />
		</manifest>
	</jar>
</target>
	
<target name="jar.emu" depends="prepare.dist">
	<manifestclasspath property="jar.emu.classpath" jarfile="${dir.dist}/${lib.dir}/${jar.emu.name}.jar">
		<classpath refid="classpath" />
	</manifestclasspath>

	<echo message="lib: ${jar.emu.classpath}" level="debug" />

	<!-- creates your jar with the contents inside "bin" (now with your .class and .jar dependencies) -->
	<jar destfile="${dir.dist}/${lib.dir}/${jar.emu.name}.jar">
		<fileset dir="${build}">
			<include name="**/*.class" />
			<include name="**/*.properties" />
			<exclude name="**/test/*.class" />
			<exclude name="**/bus/*.class" />
			<exclude name="**/server/*.class" />
			<exclude name="**/plugin/*.class" />
			<exclude name="**/test/*.class" />
			<exclude name="**/sdk/*.class" />
		</fileset>
		<manifest>
			<!-- Who is building this jar? -->
			<attribute name="Built-By" value="${user.name}" />
			<!-- Information about the program itself -->
			<attribute name="Implementation-Title" value="${emu.name}" />
			<attribute name="Implementation-Version" value="${emu.version}" />
			<attribute name="Class-Path" value="${jar.emu.classpath}" />
			<attribute name="Built-Date" value="${TODAY}" />
		</manifest>
	</jar>
</target>
	
<target name="jar.main" depends="jar.sdk">

	<manifestclasspath property="jar.classpath" jarfile="${dir.dist}/${jar.main.name}-${version}.jar">
		<classpath refid="classpath" />
	</manifestclasspath>

	<echo message="lib: ${jar.classpath}" level="debug" />

	<!-- creates your jar with the contents inside "bin" (now with your .class and .jar dependencies) -->
	<jar destfile="${dir.dist}/${jar.main.name}.jar">
		<fileset dir="${build}">
			<include name="**/*.class" />
			<include name="**/*.properties" />
			<include name="**/*.xml" />
			<exclude name="**/test/*.class" />
			<exclude name="**/bus/*.class" />
			<exclude name="**/sdk/*.class" />
			<exclude name="**/plugin/*.class" />
			<exclude name="**/emulator/*.class" />
		</fileset>
		<manifest>
			<!-- Who is building this jar? -->
			<attribute name="Built-By" value="${user.name}" />
			<!-- Information about the program itself -->
			<attribute name="Implementation-Title" value="${app.name}" />
			<attribute name="Implementation-Version" value="${version}" />
			<!-- this tells which class should run when executing your jar -->
			<attribute name="Main-Class" value="${main.class}" />
			<attribute name="Class-Path" value="${jar.classpath}" />
			<attribute name="Built-Date" value="${TODAY}" />
		</manifest>
	</jar>
</target>
	
<target name="create.dist" depends="prepare.dist, jar.sdk, jar.emu, jar.main, shell" description="prepeare the relese of the dist">
	<!-- copy the louncher to "dist" directory  -->
	<copy todir="${dir.dist}">
		<!-- fileset dir="${project.home}" includes="*.bat" -->
		<!-- fileset dir="${project.home}" includes="*.sh" -->
		<fileset dir="${project.home}" includes="lgpl-3.0.txt" />
	</copy>

	<!-- copy the configutation to "conf" directory  -->
	<copy todir="${dir.dist}${conf.dir}">
		<fileset dir="${project.home}${conf.dir}" includes="config.xml" />
		<fileset dir="${project.home}${conf.dir}" includes="emuNew.xml" />
		<fileset dir="${project.home}${conf.dir}" includes="log4j.xml" />
	</copy>
</target>
	
<target name="copy.jar" description="copy jar from other project to lib dir">
	
	<delete verbose="true">
		<fileset dir="${project.home}/${lib.dir}" casesensitive="false">
		    <include name="own-*"/>
		</fileset>
	</delete>

	<!-- copy jar in lib directory  -->
	<copy todir="${project.home}/${lib.dir}" failonerror="false" overwrite="true" verbose="true">
		<fileset dir="${workspace}/${jar.name.1}/${dest}" />
		<fileset dir="${workspace}/${jar.name.2}/${dest}" />
	</copy>
</target>
	
</project>